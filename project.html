<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Project Tracker</title>

    <style>
      /* Base styles */
      body {
        font-family: Arial, sans-serif;
        background-color: #c5daf9;
        margin: 15px;
        color: #000;
        font-size: 10px;
      }

      h1 {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 6px;
      }
      
      /* **** NEW: Style for the Sorter Type Subtitle **** */
      #project-sorter-type {
        font-size: 14px;
        font-weight: bold;
        color: #333;
        margin-top: -5px;
        margin-bottom: 15px;
      }

      .header {
        font-size: 11px;
        margin-bottom: 12px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .header div {
        min-width: 140px;
      }

      .back-button {
        font-size: 10px;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 3px;
        background-color: #007bff;
        color: white;
        user-select: none;
        text-decoration: none;
        display: inline-block;
      }
      .back-button:hover {
        background-color: #0056b3;
      }

      .overall-progress-container {
        width: 150px;
        height: 18px;
        border: 1px solid #999;
        background: white;
        border-radius: 4px;
        overflow: hidden;
        vertical-align: middle;
        display: inline-block;
      }

      .overall-progress-fill {
        height: 100%;
        background-color: #2da52a;
        width: 0%; /* Start at 0% */
        transition: width 0.5s ease;
      }

      .overall-progress-label {
        font-weight: bold;
        font-size: 12px;
        line-height: 18px;
        text-align: center;
        user-select: none;
        min-width: 40px;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        background-color: #e0eafd;
        font-size: 10px;
      }

      thead tr {
        background-color: #081c8c;
        color: white;
        font-weight: bold;
        font-size: 10px;
        user-select: none;
      }

      th,
      td {
        border: 1px solid #a7bad9;
        padding: 3px 5px;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
      }

      th:first-child,
      td:first-child,
      th:nth-child(2),
      td:nth-child(2) {
        text-align: left;
        padding-left: 6px;
        white-space: normal;
        word-break: break-word;
      }

      tbody tr.task-group {
        font-weight: bold;
        background-color: #c3d0f7;
      }

      tbody tr.subtask td:first-child,
      tbody tr.subtask td:nth-child(2) {
        text-align: left;
        padding-left: 15px;
        white-space: normal;
      }

      td.progress-cell {
        padding: 2px 3px;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .progress-bar {
        background-color: #ccc;
        border-radius: 2px;
        overflow: hidden;
        height: 14px;
        flex-grow: 1;
        vertical-align: middle;
        position: relative;
      }

      .progress-bar-fill {
        height: 100%;
        background-color: #2da52a;
        width: 0%;
        transition: width 0.4s ease;
        border-radius: 2px 0 0 2px;
      }

      /* Delay coloring */
      td.delay-zero {
        background-color: #d4edda;
      }

      td.delay-positive {
        background-color: #f8d7da;
      }

      input,
      select,
      textarea {
        font-family: Arial, sans-serif;
        font-size: 10px;
        padding: 2px 4px;
        border: 1px solid #aaa;
        border-radius: 3px;
        width: 100%;
        box-sizing: border-box;
      }

      input.number-input {
        width: 50px;
        text-align: center;
        flex-shrink: 0;
      }

      input.text-input,
      textarea.text-input {
        width: 98%;
        white-space: normal;
      }

      textarea.text-input {
        resize: vertical;
        min-height: 18px;
        vertical-align: middle;
      }

      button {
        font-size: 10px;
        padding: 2px 6px;
        margin: 0 2px;
        cursor: pointer;
        border-radius: 3px;
        border: 1px solid #555;
        background-color: #007bff;
        color: white;
        user-select: none;
      }

      button:hover {
        background-color: #0056b3;
      }

      button.toggle-btn {
        font-size: 10px;
        padding: 0px 4px;
        margin-right: 5px;
        cursor: pointer;
        border-radius: 3px;
        border: 1px solid #555;
        background-color: #f0f0f0;
        color: #333;
        font-weight: bold;
        width: 18px;
        text-align: center;
      }

      button.toggle-btn:hover {
        background-color: #ddd;
      }

      .table-container {
        overflow-x: auto;
      }
    </style>
  </head>

  <body>
    <h1 id="project-title" contenteditable="true">Loading Project...</h1>
    <h2 id="project-sorter-type"></h2>

    <div
      class="header"
      role="contentinfo"
      aria-label="Project manager contacts and overall progress"
    >
      <a href="index.html" class="back-button">&laquo; Back to Dashboard</a>

      <div><strong>Overall Project Scale:</strong></div>
      <div
        class="overall-progress-container"
        aria-label="Overall project completion progress bar"
      >
        <div id="overall-progress-fill" class="overall-progress-fill"></div>
      </div>
      <div id="overallProgressLabel" class="overall-progress-label">0%</div>
    </div>

    <div class="table-container">
      <table
        id="projectTable"
        role="grid"
        aria-label="Project Management Tasks Table"
      >
        <thead>
          <tr>
            <th style="width: 5%">Sr. No.</th>
            <th style="width: 25%">TASK TITLE</th>
            <th style="width: 12%">TASK OWNER</th>
            <th style="width: 15%">PROGRESS %</th>
            <th style="width: 7%">PLANNED START DATE</th>
            <th style="width: 7%">PLANNED DUE DATE</th>
            <th style="width: 7%">PLANNED DURATION</th>
            <th style="width: 7%">ACTUAL START DATE</th>
            <th style="width: 7%">ACTUAL DUE DATE</th>
            <th style="width: 7%">ACTUAL DURATION</th>
            <th style="width: 7%">Delay</th>
            <th style="width: 10%">Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div style="margin-top: 15px">
      <button onclick="addProjectGroup()">+ Add Project Group</button>
    </div>

    <script>
      // Global variables for this project
      let data = [];
      let projectId = null;

      // --- NEW: Data Saving and Loading ---

      // Function to save all changes to the browser
      function saveData() {
        if (!projectId) return;
        localStorage.setItem(
          `NidoProjectData-${projectId}`,
          JSON.stringify(data)
        );
      }

      // Function to load the project on page start
      function loadProject() {
        // 1. Get Project ID from the URL
        const urlParams = new URLSearchParams(window.location.search);
        projectId = urlParams.get("id");
        if (!projectId) {
          alert("No project ID specified. Redirecting to dashboard.");
          window.location.href = "index.html";
          return;
        }

        // 2. Get the project name from the main list
        const projects =
          JSON.parse(localStorage.getItem("NidoProjectList")) || [];
        const project = projects.find((p) => p.id === projectId);
        if (project) {
          // 3. Set the page title
          document.getElementById("project-title").textContent = project.name;
          document.title = project.name; // Set browser tab title
          
          // **** NEW: Set the sorter type subtitle ****
          document.getElementById("project-sorter-type").textContent = project.sorterType;

        } else {
          alert("Project not found. Redirecting to dashboard.");
          window.location.href = "index.html";
          return;
        }

        // 4. Load this project's specific data
        const savedData = localStorage.getItem(`NidoProjectData-${projectId}`);
        if (savedData) {
          data = JSON.parse(savedData);
        } else {
          data = []; // Or start with some default data
        }

        // 5. Render the table
        renderTable();
      }

      // --- Utility Functions ---

      function generateId() {
        return "_" + Math.random().toString(36).substr(2, 9);
      }

      function formatInputDate(dateStr) {
        if (!dateStr) return "";
        const parts = dateStr.split("/");
        if (parts.length !== 3) return "";
        let year = parts[2].length === 2 ? "20" + parts[2] : parts[2];
        let month = parts[0].padStart(2, "0");
        let day = parts[1].padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function formatDisplayDate(dateStr) {
        if (!dateStr) return "";
        const d = new Date(dateStr);
        if (isNaN(d)) return "";
        let m = d.getMonth() + 1;
        let day = d.getDate();
        let year = d.getFullYear() % 100;
        return `${m}/${day}/${year}`;
      }

      function daysDiff(startDate, endDate) {
        if (!startDate || !endDate) return 0;
        const start = new Date(startDate);
        const end = new Date(endDate);
        const msPerDay = 1000 * 60 * 60 * 24;
        const diff = (end.getTime() - start.getTime()) / msPerDay + 1;
        return diff < 0 ? 0 : Math.round(diff);
      }

      function recalcDurations(item) {
        item.plannedDuration = daysDiff(
          formatInputDate(item.plannedStart),
          formatInputDate(item.plannedDue)
        );
        item.actualDuration = daysDiff(
          formatInputDate(item.actualStart),
          formatInputDate(item.actualDue)
        );
        item.delay = Math.max(0, item.actualDuration - item.plannedDuration);
      }

      // --- Core Table Functions ---

      function renderRow(item, level = 0) {
        const tr = document.createElement("tr");
        tr.dataset.id = item.id;
        tr.classList.add(level === 0 ? "task-group" : "subtask");

        const indentStyle =
          level === 0 ? "" : "padding-left:15px;";
        const delayClass = item.delay > 0 ? "delay-positive" : "delay-zero";
        const progressPercent = Number(item.progress) || 0;
        const barWidth = Math.min(progressPercent, 100);

        const isGroupWithTasks =
          level === 0 && item.subtasks && item.subtasks.length > 0;
        const progressDisabled = isGroupWithTasks ? "disabled" : "";

        tr.innerHTML = `
          <td>
            ${
              level === 0 && item.subtasks && item.subtasks.length > 0
                ? `<button class="toggle-btn" data-id="${item.id}">${item.isCollapsed ? '+' : '-'}</button>`
                : level === 0 ? `<span style="display: inline-block; width: 23px; margin-right: 5px;"></span>` : ''
            }
            <input class="text-input" value="${
              item.num
            }" style="width: ${level === 0 ? '50px' : '80px'}; font-weight:bold;" data-prop="num" data-id="${item.id}" />
          </td>
          <td><textarea class="text-input" style="${indentStyle}" data-prop="title" data-id="${item.id}">${item.title}</textarea></td>
          <td><input class="text-input" value="${item.owner}" data-prop="owner" data-id="${item.id}" /></td>
          <td class="progress-cell">
            <input type="number" class="number-input" value="${progressPercent}" data-prop="progress" data-id="${item.id}" ${progressDisabled} />
            <div class="progress-bar" aria-hidden="true" title="${progressPercent}%">
              <div class="progress-bar-fill" style="width: ${barWidth}%;"></div>
            </div>
          </td>
          <td><input type="date" value="${formatInputDate(item.plannedStart)}" data-prop="plannedStart" data-id="${item.id}" /></td>
          <td><input type="date" value="${formatInputDate(item.plannedDue)}" data-prop="plannedDue" data-id="${item.id}" /></td>
          <td><input class="number-input" value="${item.plannedDuration}" disabled /></td>
          <td><input type="date" value="${formatInputDate(item.actualStart)}" data-prop="actualStart" data-id="${item.id}" /></td>
          <td><input type="date" value="${formatInputDate(item.actualDue)}" data-prop="actualDue" data-id="${item.id}" /></td>
          <td><input class="number-input" value="${item.actualDuration}" disabled /></td>
          <td class="${delayClass}"><input class="number-input" value="${item.delay}" disabled /></td>
          <td>
            ${level === 0 ? `<button class="add-subtask-btn" data-id="${item.id}">+ Subtask</button>` : ""}
            <button class="delete-btn" data-id="${item.id}">Delete</button>
          </td>
        `;
        return tr;
      }

      function renderTable() {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        // Recalculate all group progress *before* rendering
        data.forEach((group) => {
          if (group.subtasks && group.subtasks.length > 0) {
            let total = 0;
            group.subtasks.forEach((task) => {
              total += Number(task.progress);
            });
            group.progress = Math.round(total / group.subtasks.length);
          }
        });

        // Render rows
        data.forEach((group) => {
          recalcDurations(group);
          tbody.appendChild(renderRow(group, 0));
          if (group.subtasks && !group.isCollapsed) {
            group.subtasks.forEach((task) => {
              recalcDurations(task);
              tbody.appendChild(renderRow(task, 1));
            });
          }
        });

        updateOverallProgress();
        saveData(); // Auto-save after every render
      }

      function findById(id) {
        for (const group of data) {
          if (group.id === id) return { obj: group, parent: null };
          if (group.subtasks) {
            for (const task of group.subtasks) {
              if (task.id === id) return { obj: task, parent: group };
            }
          }
        }
        return null;
      }

      function updateOverallProgress() {
        const fillElement = document.getElementById("overall-progress-fill");
        const labelElement = document.getElementById("overallProgressLabel");

        if (data.length === 0) {
          fillElement.style.width = "0%";
          labelElement.textContent = "0%";
          return;
        }

        let totalProgress = 0;
        data.forEach((group) => {
          totalProgress += Number(group.progress);
        });

        const overallPercent = Math.round(totalProgress / data.length);
        const barWidth = Math.min(overallPercent, 100);

        fillElement.style.width = barWidth + "%";
        labelElement.textContent = overallPercent + "%";
      }

      // --- Event Listeners ---

      document
        .getElementById("tableBody")
        .addEventListener("input", (e) => {
          const el = e.target;
          const id = el.dataset.id;
          const prop = el.dataset.prop;
          if (!id || !prop) return;
          const found = findById(id);
          if (!found) return;

          if (prop === "progress") {
            let val = el.value;
            let numVal = Number(val);
            if (val === "") numVal = 0;
            if (isNaN(numVal)) numVal = found.obj[prop] || 0;
            if (numVal < 0) numVal = 0;
            found.obj[prop] = numVal;

            const barEl = el.closest("td").querySelector(".progress-bar-fill");
            if (barEl) {
              const barWidth = Math.min(numVal, 100);
              barEl.style.width = barWidth + "%";
              barEl.closest(".progress-bar").title = numVal + "%";
            }

            if (found.parent) {
              let group = found.parent;
              let total = 0;
              group.subtasks.forEach((task) => {
                total += Number(task.progress);
              });
              let avg = Math.round(total / group.subtasks.length);
              group.progress = avg;

              const groupRow = document.querySelector(`tr[data-id="${group.id}"]`);
              if (groupRow) {
                groupRow.querySelector('.number-input[data-prop="progress"]').value = avg;
                groupRow.querySelector(".progress-bar-fill").style.width = Math.min(avg, 100) + "%";
                groupRow.querySelector(".progress-bar").title = avg + "%";
              }
            }
            updateOverallProgress();
          } else {
            let val = el.value.trim();
            if (["plannedStart", "plannedDue", "actualStart", "actualDue"].includes(prop)) {
              val = formatDisplayDate(val);
            }
            found.obj[prop] = val;
            if (["plannedStart", "plannedDue", "actualStart", "actualDue"].includes(prop)) {
              recalcDurations(found.obj);
              renderTable(); // Re-render for duration changes
            }
          }
          saveData(); // Auto-save on input
        });

      document
        .getElementById("tableBody")
        .addEventListener("change", (e) => {
          const el = e.target;
          const prop = el.dataset.prop;
          if (["plannedStart", "plannedDue", "actualStart", "actualDue"].includes(prop)) {
            recalcDurations(findById(el.dataset.id).obj);
            renderTable();
          }
        });

      document
        .getElementById("tableBody")
        .addEventListener("click", (e) => {
          const btn = e.target;

          if (btn.classList.contains("toggle-btn")) {
            const id = btn.dataset.id;
            const group = data.find((g) => g.id === id);
            if (group) {
              group.isCollapsed = !group.isCollapsed;
              renderTable(); // Will save
            }
          } else if (btn.classList.contains("delete-btn")) {
            const id = btn.dataset.id;
            const found = findById(id);
            if (!found) return;
            if (!found.parent) {
              if (confirm(`Delete project group "${found.obj.title}" and all its subtasks?`)) {
                data = data.filter((g) => g.id !== id);
                renderTable(); // Will save
              }
            } else {
              if (confirm(`Delete task "${found.obj.title}"?`)) {
                found.parent.subtasks = found.parent.subtasks.filter((t) => t.id !== id);
                renderTable(); // Will save
              }
            }
          } else if (btn.classList.contains("add-subtask-btn")) {
            const groupId = btn.dataset.id;
            const group = data.find((g) => g.id === groupId);
            if (!group) return;
            let subTaskNum = getNextSubtaskNumber(group);
            group.subtasks.push({
              id: generateId(),
              num: subTaskNum,
              title: "New Subtask",
              owner: "",
              progress: 0,
              plannedStart: "",
              plannedDue: "",
              plannedDuration: 0,
              actualStart: "",
              actualDue: "",
              actualDuration: 0,
              delay: 0,
            });
            renderTable(); // Will save
          }
        });

      function addProjectGroup() {
        let nextNum = getNextGroupNumber();
        data.push({
          id: generateId(),
          num: nextNum,
          title: "New Project Group",
          owner: "",
          progress: 0,
          plannedStart: "",
          plannedDue: "",
          plannedDuration: 0,
          actualStart: "",
          actualDue: "",
          actualDuration: 0,
          delay: 0,
          isCollapsed: false,
          subtasks: [],
        });
        renderTable(); // Will save
      }

      function getNextGroupNumber() {
        let nums = data.map((g) => Number(g.num));
        let max = nums.length ? Math.max(...nums) : 0;
        return (max + 1).toString();
      }

      function getNextSubtaskNumber(group) {
        if (!group.subtasks.length) return group.num + ".1";
        let maxN = 0;
        group.subtasks.forEach((t) => {
          let subNum = t.num.trim();
          if (subNum.startsWith(group.num + ".")) {
            let remainder = subNum.substring(group.num.length + 1);
            if (!isNaN(remainder) && remainder !== "") {
              let n = parseInt(remainder);
              if (n > maxN) maxN = n;
            }
          }
        });
        return `${group.num}.${maxN + 1}`;
      }

      // --- Save Title on Edit ---
      document
        .getElementById("project-title")
        .addEventListener("blur", () => {
          const newTitle = document
            .getElementById("project-title")
            .textContent.trim();
          if (!newTitle) {
            // Don't allow blank title
            loadProject(); // Revert to old name
            return;
          }

          // Get the project list
          const projects =
            JSON.parse(localStorage.getItem("NidoProjectList")) || [];
          const project = projects.find((p) => p.id === projectId);

          if (project && project.name !== newTitle) {
            project.name = newTitle;
            // Save the updated project list
            localStorage.setItem("NidoProjectList", JSON.stringify(projects));
            // Update the browser tab title
            document.title = newTitle;
          }
        });

      // --- Initial Page Load ---
      loadProject();
    </script>
  </body>
</html>
